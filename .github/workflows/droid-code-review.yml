name: Droid Code Review

on:
  issue_comment:
    types: [created]

concurrency:
  group: droid-review-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run on PR comments that contain "@droid review" from authorized users
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@droid review') &&
      (
        github.event.comment.user.login == 'vstakhov'
      )

    steps:
      - name: Acknowledge review start with reaction
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='eyes'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        run: |
          gh pr checkout ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Droid CLI
        run: |
          curl -fsSL https://app.factory.ai/cli | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          "$HOME/.local/bin/droid" --version

      - name: Configure git identity
        run: |
          git config user.name "Droid Code Reviewer"
          git config user.email "droid@factory.ai"

      - name: Perform automated code review
        env:
          FACTORY_API_KEY: ${{ secrets.FACTORY_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cat > prompt.txt << 'EOF'
          You are an automated code review system for the rbldnsd project.
          Review the PR diff and identify clear issues that need to be fixed.

          First, use the Web Fetch tool to get the full PR context from:
          https://github.com/${{ github.repository }}/pull/${{ github.event.issue.number }}

          This will provide you with:
          - PR title, description, and metadata
          - Complete diff with line numbers for positioning comments
          - Changed files with their status
          - Existing comments and review threads (to avoid duplicates)

          Task: After fetching the PR data, review the code changes and directly submit your findings using the GitHub CLI.

          ## rbldnsd C Code Review Guidelines

          ### Memory Safety (CRITICAL)
          - Check for leaks, double-frees, and use-after-free
          - Validate ownership/lifetime of buffers and pointers
          - Ensure allocations are checked for failure
          - Be careful with stack vs heap lifetimes

          ### Bounds and Parsing
          - Verify all length calculations and bounds checks
          - Watch for off-by-one errors
          - Avoid trusting input lengths from the network or files
          - Check for integer overflows in size computations

          ### DNS/Networking Correctness
          - Ensure packet parsing is robust to malformed input
          - Avoid reading past packet boundaries
          - Verify endian conversions where appropriate

          ### Error Handling
          - Check return values from syscalls/library calls
          - Ensure cleanup on error paths
          - Avoid silent failures

          ### Concurrency
          - Flag race conditions on shared state
          - Check signal/async-safety issues

          ### Security
          - Buffer overflows, format-string issues
          - Potential DoS vectors (unbounded loops, excessive allocations)

          Comment format:
          - Clearly describe the issue
          - Provide a concrete fix
          - When possible, suggest exact code change
          - Be specific about why it's a problem
          - Use technical language, no emojis

          Skip commenting on:
          - Code style and formatting
          - Naming conventions
          - Minor performance optimizations
          - Architectural decisions
          - Test coverage (unless tests are broken)
          - Documentation (unless it's misleading)

          Use the fetched PR data to:
          - Avoid repeating resolved issues unless the problem still exists
          - Reference ongoing discussions when adding follow-ups
          - Prefer replying to existing threads instead of creating duplicates
          - Ignore your own previous resolved comments
          - **CRITICAL: Stop repeating dismissed feedback** - If a maintainer has replied to your comment explaining why something is intentional, by design, or not a bug, DO NOT report the same issue again in subsequent reviews
          - **Respect maintainer decisions** - When a human reviewer disagrees with your assessment and provides rationale, defer to their judgment and do not re-raise the same concern
          - **Check comment thread context** - Before posting a comment, review all replies in existing threads. If a maintainer has already addressed your concern with an explanation, skip that issue entirely
          - **Recognize intentional design** - Code that a maintainer explicitly defends as "intentional behavior" or "by design" should not be flagged as a bug, even if it doesn't match your expectations

          Position calculation:
          - Use the line position from the diff data (line number in diff, not file)
          - Comments must align with exact changed lines only

          How to submit your review:
          Use the GitHub CLI (gh) to submit your review. The PR number is ${{ github.event.issue.number }}
          and repository is ${{ github.repository }}.

          GitHub CLI command examples:
          - For inline comments with review summary: gh pr review ${{ github.event.issue.number }} --comment --body "Review summary text here"
          - To request changes with inline comments: gh pr review ${{ github.event.issue.number }} --request-changes --body "Found issues that need fixing"
          - To approve: gh pr review ${{ github.event.issue.number }} --approve --body "No issues found"
          - For inline comments on specific lines: gh pr review ${{ github.event.issue.number }} --comment --body-file review.txt (where review.txt contains formatted review)

          CRITICAL: DO NOT post test comments or experiment with the API - every comment is visible to maintainers and contributors.
          You must use the correct command on the first attempt. If unsure about syntax, default to: gh pr review ${{ github.event.issue.number }} --comment --body "your message"

          Guidelines:
          - Submit at most 10 comments total, prioritizing the most critical issues
          - Each comment must be actionable and clear about what needs to be fixed
          - Check for existing bot comments before posting duplicates
          - Include a summary in the review body when submitting multiple inline comments
          - If no issues found, post a single approval comment
          EOF

          echo "Running code review analysis and submitting results..."
          droid exec --auto high --model claude-sonnet-4-5-20250929 -f prompt.txt

      - name: Post review completion comment
        if: ${{ success() }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "Code review completed successfully. The review has been submitted."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dismiss previous change requests if approved
        if: ${{ success() }}
        run: |
          # Get all reviews for this PR
          REVIEWS=$(gh api "/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/reviews" --jq '.[] | select(.state == "CHANGES_REQUESTED" and .user.login == "github-actions[bot]") | .id')

          # Dismiss each change request review
          for REVIEW_ID in $REVIEWS; do
            echo "Dismissing review $REVIEW_ID"
            gh api \
              --method PUT \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}/reviews/$REVIEW_ID/dismissals" \
              -f message="Dismissed after new approval" || echo "Failed to dismiss review $REVIEW_ID (may already be dismissed)"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload debug artifacts on failure
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: droid-review-debug-${{ github.run_id }}
          path: |
            prompt.txt
            ${{ runner.home }}/.factory/logs/droid-log-single.log
            ${{ runner.home }}/.factory/logs/console.log
          if-no-files-found: ignore
          retention-days: 7
